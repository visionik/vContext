{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://vagenda.dev/schemas/vagenda-core.schema.json",
  "title": "vAgenda Core Schema",
  "description": "JSON Schema for vAgenda core document structure (v0.3). Extensions may add fields; unknown fields are allowed unless otherwise stated.",
  "type": "object",
  "required": ["vAgendaInfo"],
  "properties": {
    "vAgendaInfo": {"$ref": "#/$defs/vAgendaInfo"},
    "todoList": {"$ref": "#/$defs/TodoList"},
    "plan": {"$ref": "#/$defs/Plan"}
  },
  "oneOf": [
    {
      "required": ["todoList"],
      "not": {"required": ["plan"]}
    },
    {
      "required": ["plan"],
      "not": {"required": ["todoList"]}
    }
  ],
  "additionalProperties": true,
  "$defs": {
    "vAgendaInfo": {
      "type": "object",
      "required": ["version"],
      "properties": {
        "version": {"type": "string", "const": "0.3"},
        "author": {"type": "string"},
        "description": {"type": "string"},
        "metadata": {"type": "object"},
        "created": {"$ref": "#/$defs/dateTime"},
        "updated": {"$ref": "#/$defs/dateTime"},
        "timezone": {"type": "string"}
      },
      "additionalProperties": true
    },
    "TodoList": {
      "type": "object",
      "required": ["items"],
      "properties": {
        "items": {
          "type": "array",
          "items": {"$ref": "#/$defs/TodoItem"}
        },
        "id": {"type": "string"},
        "uid": {"type": "string"},
        "title": {"type": "string"},
        "description": {"type": "string"},
        "tags": {"type": "array", "items": {"type": "string"}},
        "metadata": {"type": "object"},
        "uris": {"type": "array", "items": {"$ref": "#/$defs/URI"}},
        "agent": {"$ref": "#/$defs/Agent"},
        "lastModifiedBy": {"$ref": "#/$defs/Agent"},
        "changeLog": {
          "type": "array",
          "items": {"$ref": "#/$defs/Change"}
        },
        "sequence": {"type": "integer", "minimum": 0},
        "playbook": {"type": "object"}
      },
      "additionalProperties": true
    },
    "TodoItem": {
      "type": "object",
      "required": ["title", "status"],
      "properties": {
        "id": {"type": "string"},
        "uid": {"type": "string"},
        "title": {"type": "string", "minLength": 1},
        "status": {"$ref": "#/$defs/TodoStatus"},
        "description": {"type": "string"},
        "priority": {"enum": ["low", "medium", "high", "critical"]},
        "tags": {"type": "array", "items": {"type": "string"}},
        "metadata": {"type": "object"},
        "created": {"$ref": "#/$defs/dateTime"},
        "updated": {"$ref": "#/$defs/dateTime"},
        "completed": {"$ref": "#/$defs/dateTime"},
        "dueDate": {"$ref": "#/$defs/dateTime"},
        "percentComplete": {"type": "number", "minimum": 0, "maximum": 100},
        "timezone": {"type": "string"},
        "dependencies": {"type": "array", "items": {"type": "string"}},
        "participants": {"type": "array", "items": {"$ref": "#/$defs/Participant"}},
        "relatedComments": {"type": "array", "items": {"type": "string"}},
        "uris": {"type": "array", "items": {"$ref": "#/$defs/URI"}},
        "recurrence": {"$ref": "#/$defs/RecurrenceRule"},
        "reminders": {"type": "array", "items": {"$ref": "#/$defs/Reminder"}},
        "classification": {"enum": ["public", "private", "confidential"]},
        "sequence": {"type": "integer", "minimum": 0},
        "lastModifiedBy": {"$ref": "#/$defs/Agent"},
        "lockedBy": {"$ref": "#/$defs/Lock"}
      },
      "additionalProperties": true
    },
    "Plan": {
      "type": "object",
      "required": ["title", "status", "narratives"],
      "properties": {
        "id": {"type": "string"},
        "uid": {"type": "string"},
        "title": {"type": "string", "minLength": 1},
        "status": {"$ref": "#/$defs/PlanStatus"},
        "author": {"type": "string"},
        "reviewers": {"type": "array", "items": {"type": "string"}},
        "description": {"type": "string"},
        "tags": {"type": "array", "items": {"type": "string"}},
        "metadata": {"type": "object"},
        "narratives": {
          "type": "object",
          "required": ["proposal"],
          "properties": {
            "proposal": {"$ref": "#/$defs/Narrative"},
            "problem": {"$ref": "#/$defs/Narrative"},
            "context": {"$ref": "#/$defs/Narrative"},
            "alternatives": {"$ref": "#/$defs/Narrative"},
            "risks": {"$ref": "#/$defs/Narrative"},
            "testing": {"$ref": "#/$defs/Narrative"},
            "rollout": {"$ref": "#/$defs/Narrative"},
            "custom": {"type": "array", "items": {"$ref": "#/$defs/Narrative"}}
          },
          "additionalProperties": true
        },
        "items": {"type": "array", "items": {"$ref": "#/$defs/PlanItem"}},
        "uris": {"type": "array", "items": {"$ref": "#/$defs/URI"}},
        "references": {"type": "array", "items": {"$ref": "#/$defs/Reference"}},
        "attachments": {"type": "array", "items": {"$ref": "#/$defs/Attachment"}},
        "created": {"$ref": "#/$defs/dateTime"},
        "updated": {"$ref": "#/$defs/dateTime"},
        "timezone": {"type": "string"},
        "agent": {"$ref": "#/$defs/Agent"},
        "lastModifiedBy": {"$ref": "#/$defs/Agent"},
        "changeLog": {"type": "array", "items": {"$ref": "#/$defs/Change"}},
        "sequence": {"type": "integer", "minimum": 0},
        "fork": {"$ref": "#/$defs/Fork"},
        "playbook": {"type": "object"}
      },
      "additionalProperties": true
    },
    "PlanItem": {
      "type": "object",
      "required": ["title", "status"],
      "properties": {
        "id": {"type": "string"},
        "uid": {"type": "string"},
        "title": {"type": "string", "minLength": 1},
        "status": {"$ref": "#/$defs/PlanItemStatus"},
        "description": {"type": "string"},
        "tags": {"type": "array", "items": {"type": "string"}},
        "metadata": {"type": "object"},
        "dependencies": {"type": "array", "items": {"type": "string"}},
        "subItems": {"type": "array", "items": {"$ref": "#/$defs/PlanItem"}},
        "todoList": {"$ref": "#/$defs/TodoList"},
        "participants": {"type": "array", "items": {"$ref": "#/$defs/Participant"}},
        "location": {"$ref": "#/$defs/Location"},
        "uris": {"type": "array", "items": {"$ref": "#/$defs/URI"}},
        "reminders": {"type": "array", "items": {"$ref": "#/$defs/Reminder"}},
        "classification": {"enum": ["public", "private", "confidential"]},
        "startDate": {"$ref": "#/$defs/dateTime"},
        "endDate": {"$ref": "#/$defs/dateTime"},
        "percentComplete": {"type": "number", "minimum": 0, "maximum": 100},
        "timezone": {"type": "string"},
        "sequence": {"type": "integer", "minimum": 0},
        "lastModifiedBy": {"$ref": "#/$defs/Agent"},
        "lockedBy": {"$ref": "#/$defs/Lock"}
      },
      "additionalProperties": true
    },
    "Narrative": {
      "type": "object",
      "required": ["title", "content"],
      "properties": {
        "title": {"type": "string"},
        "content": {"type": "string"}
      },
      "additionalProperties": true
    },
    "TodoStatus": {"enum": ["pending", "inProgress", "completed", "blocked", "cancelled"]},
    "PlanItemStatus": {"enum": ["pending", "inProgress", "completed", "blocked", "cancelled"]},
    "PlanStatus": {"enum": ["draft", "proposed", "approved", "inProgress", "completed", "cancelled"]},
    "Participant": {
      "type": "object",
      "required": ["id", "role"],
      "properties": {
        "id": {"type": "string"},
        "name": {"type": "string"},
        "email": {"type": "string"},
        "role": {"enum": ["owner", "assignee", "reviewer", "observer", "contributor"]},
        "status": {"enum": ["accepted", "declined", "tentative", "needsAction"]}
      },
      "additionalProperties": true
    },
    "URI": {
      "type": "object",
      "required": ["uri"],
      "properties": {
        "uri": {"type": "string"},
        "description": {"type": "string"},
        "type": {"type": "string"},
        "title": {"type": "string"},
        "tags": {"type": "array", "items": {"type": "string"}}
      },
      "additionalProperties": true
    },
    "Location": {
      "type": "object",
      "properties": {
        "name": {"type": "string"},
        "address": {"type": "string"},
        "geo": {
          "type": "array",
          "minItems": 2,
          "maxItems": 2,
          "items": {"type": "number"}
        },
        "url": {"type": "string"}
      },
      "additionalProperties": true
    },
    "Reference": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {"enum": ["file", "line", "range", "url", "issue", "pr"]},
        "path": {"type": "string"},
        "line": {"type": "integer", "minimum": 1},
        "start": {"type": "integer", "minimum": 1},
        "end": {"type": "integer", "minimum": 1},
        "description": {"type": "string"}
      },
      "additionalProperties": true
    },
    "Attachment": {
      "type": "object",
      "required": ["name", "type"],
      "properties": {
        "name": {"type": "string"},
        "type": {"type": "string"},
        "path": {"type": "string"},
        "url": {"type": "string"},
        "encoding": {"type": "string"},
        "data": {"type": "string"}
      },
      "additionalProperties": true
    },
    "RecurrenceRule": {
      "type": "object",
      "required": ["frequency"],
      "properties": {
        "frequency": {"enum": ["daily", "weekly", "monthly", "yearly"]},
        "interval": {"type": "integer", "minimum": 1},
        "until": {"$ref": "#/$defs/dateTime"},
        "count": {"type": "integer", "minimum": 1},
        "byDay": {
          "type": "array",
          "items": {"enum": ["MO", "TU", "WE", "TH", "FR", "SA", "SU"]}
        },
        "byMonth": {"type": "array", "items": {"type": "integer", "minimum": 1, "maximum": 12}},
        "byMonthDay": {"type": "array", "items": {"type": "integer", "minimum": 1, "maximum": 31}}
      },
      "additionalProperties": true
    },
    "Reminder": {
      "type": "object",
      "required": ["trigger", "action"],
      "properties": {
        "trigger": {"type": "string"},
        "action": {"enum": ["display", "email", "webhook", "audio"]},
        "description": {"type": "string"}
      },
      "additionalProperties": true
    },
    "Agent": {
      "type": "object",
      "required": ["id", "type"],
      "properties": {
        "id": {"type": "string"},
        "type": {"enum": ["human", "aiAgent", "system"]},
        "name": {"type": "string"},
        "email": {"type": "string"},
        "model": {"type": "string"},
        "version": {"type": "string"}
      },
      "additionalProperties": true
    },
    "Change": {
      "type": "object",
      "required": ["sequence", "timestamp", "agent", "operation"],
      "properties": {
        "sequence": {"type": "integer", "minimum": 0},
        "timestamp": {"$ref": "#/$defs/dateTime"},
        "agent": {"$ref": "#/$defs/Agent"},
        "operation": {"enum": ["create", "update", "delete", "fork", "merge"]},
        "reason": {"type": "string"},
        "path": {"type": "string"},
        "oldValue": {},
        "newValue": {},
        "description": {"type": "string"},
        "snapshotUri": {"type": "string"},
        "relatedChanges": {"type": "array", "items": {"type": "string"}}
      },
      "additionalProperties": true
    },
    "Fork": {
      "type": "object",
      "required": ["parentUid", "parentSequence", "forkedAt"],
      "properties": {
        "parentUid": {"type": "string"},
        "parentSequence": {"type": "integer", "minimum": 0},
        "forkedAt": {"$ref": "#/$defs/dateTime"},
        "forkReason": {"type": "string"},
        "mergeStatus": {"enum": ["unmerged", "mergePending", "merged", "conflict"]}
      },
      "additionalProperties": true
    },
    "Lock": {
      "type": "object",
      "required": ["agent", "acquiredAt", "type"],
      "properties": {
        "agent": {"$ref": "#/$defs/Agent"},
        "acquiredAt": {"$ref": "#/$defs/dateTime"},
        "expiresAt": {"$ref": "#/$defs/dateTime"},
        "type": {"enum": ["soft", "hard"]}
      },
      "additionalProperties": true
    },
    "dateTime": {
      "type": "string",
      "format": "date-time",
      "pattern": "(Z|[+-]\\d{2}:\\d{2})$"
    }
  }
}
